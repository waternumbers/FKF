<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fast Kalman Smoother — fks • FKF</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Fast Kalman Smoother — fks" />
<meta property="og:description" content="This function can be run after running fkf to produce
&quot;smoothed&quot; estimates of the state variable a(t) and it's variance
V(t). Unlike the output of the filter, these estimates are conditional
on the entire data rather than only the past, that is it estimates \(E[at
| y1,\ldots,yn]\) and \(V[at | y1,\ldots,yn]\)." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FKF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/FKF.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/waternumbers/FKF/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fast Kalman Smoother</h1>
    <small class="dont-index">Source: <a href='https://github.com/waternumbers/FKF/blob/master/R/fks.R'><code>R/fks.R</code></a></small>
    <div class="hidden name"><code>fks.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function can be run after running <code><a href='fkf.html'>fkf</a></code> to produce
"smoothed" estimates of the state variable <code>a(t)</code> and it's variance
<code>V(t)</code>. Unlike the output of the filter, these estimates are conditional
on the entire data rather than only the past, that is it estimates \(E[at
| y1,\ldots,yn]\) and \(V[at | y1,\ldots,yn]\).</p>
    </div>

    <pre class="usage"><span class='fu'>fks</span><span class='op'>(</span><span class='va'>FKFobj</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>FKFobj</th>
      <td><p>An S3-object of class "fkf", returned by <code><a href='fkf.html'>fkf</a></code>.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A list with the following elements:</p>
<p><code>ahatt</code>  A \(m \times (n + 1)\)-matrix containing the
  smoothed state variables, i.e. \(ahat_t = E(\alpha_t | y_{n}\)<br />
  <code>Vt</code>  A \(m \times m \times (n + 1)\)-array
  containing the variances of <code>ahatt</code>, i.e. \(V_t = Var(\alpha_t |
  y_{n}\)<br /></p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'>## &lt;---------------------------------------------------------------------------&gt;</span>
<span class='co'>## Example 1: ARMA(2, 1) model estimation.</span>
<span class='co'>## &lt;---------------------------------------------------------------------------&gt;</span>
<span class='co'>## This example shows how to fit an ARMA(2, 1) model using this Kalman</span>
<span class='co'>## filter implementation (see also stats' makeARIMA and KalmanRun).</span>
<span class='va'>n</span> <span class='op'>&lt;-</span> <span class='fl'>1000</span>

<span class='co'>## Set the AR parameters</span>
<span class='va'>ar1</span> <span class='op'>&lt;-</span> <span class='fl'>0.6</span>
<span class='va'>ar2</span> <span class='op'>&lt;-</span> <span class='fl'>0.2</span>
<span class='va'>ma1</span> <span class='op'>&lt;-</span> <span class='op'>-</span><span class='fl'>0.2</span>
<span class='va'>sigma</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fl'>0.2</span><span class='op'>)</span>

<span class='co'>## Sample from an ARMA(2, 1) process</span>
<span class='va'>a</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/arima.sim.html'>arima.sim</a></span><span class='op'>(</span>model <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>ar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>ar1</span>, <span class='va'>ar2</span><span class='op'>)</span>, ma <span class='op'>=</span> <span class='va'>ma1</span><span class='op'>)</span>, n <span class='op'>=</span> <span class='va'>n</span>,
               innov <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>sigma</span><span class='op'>)</span>

<span class='co'>## Create a state space representation out of the four ARMA parameters</span>
<span class='va'>arma21ss</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>ar1</span>, <span class='va'>ar2</span>, <span class='va'>ma1</span>, <span class='va'>sigma</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>Tt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>ar1</span>, <span class='va'>ar2</span>, <span class='fl'>1</span>, <span class='fl'>0</span><span class='op'>)</span>, ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
  <span class='va'>Zt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>0</span><span class='op'>)</span>, ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
  <span class='va'>ct</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>
  <span class='va'>dt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>, nrow <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
  <span class='va'>GGt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>
  <span class='va'>H</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>ma1</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>sigma</span>
  <span class='va'>HHt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/crossprod.html'>tcrossprod</a></span><span class='op'>(</span><span class='va'>H</span><span class='op'>)</span>
  <span class='va'>a0</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span><span class='op'>)</span>
  <span class='va'>P0</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1e6</span>, nrow <span class='op'>=</span> <span class='fl'>2</span>, ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>a0 <span class='op'>=</span> <span class='va'>a0</span>, P0 <span class='op'>=</span> <span class='va'>P0</span>, ct <span class='op'>=</span> <span class='va'>ct</span>, dt <span class='op'>=</span> <span class='va'>dt</span>, Zt <span class='op'>=</span> <span class='va'>Zt</span>, Tt <span class='op'>=</span> <span class='va'>Tt</span>, GGt <span class='op'>=</span> <span class='va'>GGt</span>,
              HHt <span class='op'>=</span> <span class='va'>HHt</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'>## The objective function passed to 'optim'</span>
<span class='va'>objective</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>theta</span>, <span class='va'>yt</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>sp</span> <span class='op'>&lt;-</span> <span class='fu'>arma21ss</span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='st'>"ar1"</span><span class='op'>]</span>, <span class='va'>theta</span><span class='op'>[</span><span class='st'>"ar2"</span><span class='op'>]</span>, <span class='va'>theta</span><span class='op'>[</span><span class='st'>"ma1"</span><span class='op'>]</span>, <span class='va'>theta</span><span class='op'>[</span><span class='st'>"sigma"</span><span class='op'>]</span><span class='op'>)</span>
  <span class='va'>ans</span> <span class='op'>&lt;-</span> <span class='fu'><a href='fkf.html'>fkf</a></span><span class='op'>(</span>a0 <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>a0</span>, P0 <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>P0</span>, dt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>dt</span>, ct <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>ct</span>, Tt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>Tt</span>,
             Zt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>Zt</span>, HHt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>HHt</span>, GGt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>GGt</span>, yt <span class='op'>=</span> <span class='va'>yt</span><span class='op'>)</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>ans</span><span class='op'>$</span><span class='va'>logLik</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>theta</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>ar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span><span class='op'>)</span>, ma1 <span class='op'>=</span> <span class='fl'>0</span>, sigma <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
<span class='va'>fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/optim.html'>optim</a></span><span class='op'>(</span><span class='va'>theta</span>, <span class='va'>objective</span>, yt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>a</span><span class='op'>)</span>, hessian <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='va'>fit</span>
</div><div class='output co'>#&gt; $par
#&gt;        ar1        ar2        ma1      sigma 
#&gt;  0.6164279  0.2049020 -0.2045607  0.4291127 
#&gt; 
#&gt; $value
#&gt; [1] 580.2165
#&gt; 
#&gt; $counts
#&gt; function gradient 
#&gt;      269       NA 
#&gt; 
#&gt; $convergence
#&gt; [1] 0
#&gt; 
#&gt; $message
#&gt; NULL
#&gt; 
#&gt; $hessian
#&gt;               ar1         ar2         ma1        sigma
#&gt; ar1   2621.773643 2035.051976 1153.749013     2.253705
#&gt; ar2   2035.051976 2621.752076  237.572577     1.196811
#&gt; ma1   1153.749013  237.572577 1021.126371     1.427165
#&gt; sigma    2.253705    1.196811    1.427165 10853.052012
#&gt; </div><div class='input'>
<span class='co'>## Confidence intervals</span>
<span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>$</span><span class='va'>par</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.975</span><span class='op'>)</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/solve.html'>solve</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>$</span><span class='va'>hessian</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
      <span class='va'>fit</span><span class='op'>$</span><span class='va'>par</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.975</span><span class='op'>)</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/solve.html'>solve</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>$</span><span class='va'>hessian</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt;            ar1        ar2          ma1     sigma
#&gt; [1,] 0.4224861 0.06591009 -0.402585418 0.4102991
#&gt; [2,] 0.8103697 0.34389388 -0.006535976 0.4479263</div><div class='input'>
<span class='co'>## Filter the series with estimated parameter values</span>
<span class='va'>sp</span> <span class='op'>&lt;-</span> <span class='fu'>arma21ss</span><span class='op'>(</span><span class='va'>fit</span><span class='op'>$</span><span class='va'>par</span><span class='op'>[</span><span class='st'>"ar1"</span><span class='op'>]</span>, <span class='va'>fit</span><span class='op'>$</span><span class='va'>par</span><span class='op'>[</span><span class='st'>"ar2"</span><span class='op'>]</span>, <span class='va'>fit</span><span class='op'>$</span><span class='va'>par</span><span class='op'>[</span><span class='st'>"ma1"</span><span class='op'>]</span>, <span class='va'>fit</span><span class='op'>$</span><span class='va'>par</span><span class='op'>[</span><span class='st'>"sigma"</span><span class='op'>]</span><span class='op'>)</span>
<span class='va'>ans</span> <span class='op'>&lt;-</span> <span class='fu'><a href='fkf.html'>fkf</a></span><span class='op'>(</span>a0 <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>a0</span>, P0 <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>P0</span>, dt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>dt</span>, ct <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>ct</span>, Tt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>Tt</span>,
           Zt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>Zt</span>, HHt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>HHt</span>, GGt <span class='op'>=</span> <span class='va'>sp</span><span class='op'>$</span><span class='va'>GGt</span>, yt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>a</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>smooth</span> <span class='op'>&lt;-</span> <span class='fu'>fks</span><span class='op'>(</span><span class='va'>ans</span><span class='op'>)</span>

<span class='co'>## Compare the filtered series with the realization</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>ans</span>, at.idx <span class='op'>=</span> <span class='cn'>NA</span>, att.idx <span class='op'>=</span> <span class='fl'>1</span>, CI <span class='op'>=</span> <span class='cn'>NA</span><span class='op'>)</span>
</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/lines.html'>lines</a></span><span class='op'>(</span><span class='va'>a</span>, lty <span class='op'>=</span> <span class='st'>"dotted"</span><span class='op'>)</span>
</div><div class='img'><img src='fks-1.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'>## Compare the smoothed series with the realization</span>
<span class='co'>##plot(smooth$ahatt[1,], col=1, type='l', lty=1)</span>
<span class='co'>##lines(a, lty='dotted')</span>


<span class='co'>## &lt;---------------------------------------------------------------------------&gt;</span>
<span class='co'>## Example 2: Local level model for the Nile's annual flow.</span>
<span class='co'>## &lt;---------------------------------------------------------------------------&gt;</span>
<span class='co'>## Transition equation:</span>
<span class='co'>## alpha[t+1] = alpha[t] + eta[t], eta[t] ~ N(0, HHt)</span>
<span class='co'>## Measurement equation:</span>
<span class='co'>## y[t] = alpha[t] + eps[t], eps[t] ~  N(0, GGt)</span>

<span class='va'>y</span> <span class='op'>&lt;-</span> <span class='va'>Nile</span>
<span class='va'>y</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='cn'>NA</span>  <span class='co'># NA values can be handled</span>

<span class='co'>## Set constant parameters:</span>
<span class='va'>dt</span> <span class='op'>&lt;-</span> <span class='va'>ct</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>
<span class='va'>Zt</span> <span class='op'>&lt;-</span> <span class='va'>Tt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>
<span class='va'>a0</span> <span class='op'>&lt;-</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>            <span class='co'># Estimation of the first year flow</span>
<span class='va'>P0</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>100</span><span class='op'>)</span>     <span class='co'># Variance of 'a0'</span>

<span class='co'>## Estimate parameters:</span>
<span class='va'>fit.fkf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/optim.html'>optim</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>HHt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>y</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>.5</span>,
                   GGt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>y</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>.5</span><span class='op'>)</span>,
                 fn <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>par</span>, <span class='va'>...</span><span class='op'>)</span>
                   <span class='op'>-</span><span class='fu'><a href='fkf.html'>fkf</a></span><span class='op'>(</span>HHt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='va'>par</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, GGt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='va'>par</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>, <span class='va'>...</span><span class='op'>)</span><span class='op'>$</span><span class='va'>logLik</span>,
                 yt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>y</span><span class='op'>)</span>, a0 <span class='op'>=</span> <span class='va'>a0</span>, P0 <span class='op'>=</span> <span class='va'>P0</span>, dt <span class='op'>=</span> <span class='va'>dt</span>, ct <span class='op'>=</span> <span class='va'>ct</span>,
                 Zt <span class='op'>=</span> <span class='va'>Zt</span>, Tt <span class='op'>=</span> <span class='va'>Tt</span><span class='op'>)</span>

<span class='co'>## Filter Nile data with estimated parameters:</span>
<span class='va'>fkf.obj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='fkf.html'>fkf</a></span><span class='op'>(</span><span class='va'>a0</span>, <span class='va'>P0</span>, <span class='va'>dt</span>, <span class='va'>ct</span>, <span class='va'>Tt</span>, <span class='va'>Zt</span>, HHt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='va'>fit.fkf</span><span class='op'>$</span><span class='va'>par</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,
               GGt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='va'>fit.fkf</span><span class='op'>$</span><span class='va'>par</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>, yt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>y</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>##fks.obj &lt;- fks(fkf.obj)</span>

<span class='co'>## Compare with the stats' structural time series implementation:</span>
<span class='va'>fit.stats</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/StructTS.html'>StructTS</a></span><span class='op'>(</span><span class='va'>y</span>, type <span class='op'>=</span> <span class='st'>"level"</span><span class='op'>)</span>

<span class='va'>fit.fkf</span><span class='op'>$</span><span class='va'>par</span>
</div><div class='output co'>#&gt;       HHt       GGt 
#&gt;  1385.066 15124.131 </div><div class='input'><span class='va'>fit.stats</span><span class='op'>$</span><span class='va'>coef</span>
</div><div class='output co'>#&gt;     level   epsilon 
#&gt;  1599.452 14904.781 </div><div class='input'>
<span class='co'>## Plot the flow data together with fitted local levels:</span>
<span class='co'>##plot(y, main = "Nile flow")</span>
<span class='co'>##lines(fitted(fit.stats), col = "green")</span>
<span class='co'>##lines(ts(fkf.obj$att[1, ], start = start(y), frequency = frequency(y)), col = "blue")</span>
<span class='co'>##lines(ts(fks.obj$ahatt[1,], start = start(y), frequency = frequency(y)), col = "red")</span>
<span class='co'>##legend("top", c("Nile flow data", "Local level (StructTS)", "Local level (fkf)",</span>
<span class='co'>##       "Local level (fks)"),</span>
<span class='co'>##       col = c("black", "green", "blue", "red"), lty = 1)</span>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by David Luethi, Philipp Erb, Simon Otziger, Daniel McDonald, Paul Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


